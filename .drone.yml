kind: pipeline
name: pygna

steps:
- name: install-py3.5
  image: python:3.5
  commands:
  - pip install .
  - pygna

- name: build
  image: python:3.5
  commands:
  - python setup.py sdist bdist_wheel
  when:
    event:
    - tag

- name: publish
  image: python:3.5
  environment:
    TWINE_USERNAME:
      from_secret: TWINE_USERNAME
    TWINE_PASSWORD:
      from_secret: TWINE_PASSWORD
  commands:
  - pip install twine
  - twine upload dist/*
  when:
    event:
    - tag

- name: conda
  image: continuumio/miniconda3
  environment:
    ANACONDA_API_TOKEN:
        from_secret: ANACONDA_TOKEN
  commands:
  - conda config --set always_yes yes
  - conda update -q conda
  - conda config --add channels bioconda
  - conda config --add channels conda-forge
  - conda install conda-build anaconda-client
  - conda config --set anaconda_upload yes
  - mkdir conda-build
  - conda build . --no-build-id --output-folder ./conda-build
  - anaconda -t $${ANACONDA_API_TOKEN} upload --force -u stracquadaniolab --no-progress --private ./conda-build/**/pygna*.bz2
  when:
    event:
    - tag
